---
layout: post
---
#主动网络/可编程网络

Active Network / Programmable Networks

##因特网体系结构

基于TCP/IP协议栈，遵循“端到端原则”，网络层只提供不可靠的传输服务，应用要求的可靠性和安全性等均由端系统实现。

优点：

- 降低因特网的复杂度
- 易于增加新的应用

问题：

- 一些新兴应用需要的网络服务（如服务质量保证、多播支持、移动性支持等）无法由端系统提供。
- 要求中间节点（路由器/交换机）提供这些服务违背“端到端原则”，在实践上也面临巨大的困难，至今没有成功的先例。
- 目前的因特网体系结构已严重阻碍了因特网的发展，需要研究具有自适应、动态和智能化特性的新型网络体系结构。

##主动网络 Active Networks

主动网络允许用户对网络中间节点（如路由器、交换机等）进行编程，具有智能的中间节点通过对收到的报文进行定制处理来提供定制的服务。

通过向主动节点发送携带有移动代码的报文，用户可以按需创建自己的服务并分布到网络中。

主动网络的主动性表现在两个方面：

- 用户可将程序注入网络来扩展节点功能。
- 路由器可对流经它的用户数据包的内容执行计算，甚至改变数据包的内容。

与传统节点的存储-转发模式不同，主动节点的工作模式是存储-计算-转发。

##主动网络体系结构

主动网络由一群主动节点构成，主动节点通过执行主动包中的代码实现定制的服务。

主动节点和主动包是主动网络中最主要的两个功能实体：

- 主动节点：可编程的中间节点
- 主动包：携带了代码的分组

主动节点体系结构及主动包的定义构成了主动网络体系结构的基础。

###主动网络与传统网络的区别

主动网络并不规定网络节点应该如何协同工作来提供某种特定功能的服务，而是向网络提供了可自由增加新服务的能力。

主动网络需要解决的主要问题：

- 主动节点如何支持用不同的编程语言书写的应用程序在本地动态加载？
- 主动节点如何隔离不同的应用程序？

##主动应用

###1.可靠组播

可靠组播：

- 所有组播包最终都被正确地传送给每个接收者
- 需要有丢失检测、反馈和数据重传等措施

目前主要有两种基本的确认模型：

- 基于ACK的模型：接收者对每个正确收到的包，向发送者发送ACK。 
- 基于NACK的模型：接收者检测丢失的包，仅在发现包丢失时发送NACK。

这两种模型都会产生ACK/NACK风暴，且重传数据包都由源发出，增加发送方负担和增大重传延迟。

**主动路由器参与的可靠组播**

数据缓存：组播树上的主动路由器缓存经过的数据包。

本地恢复：当NACK到达路径上的一个主动路由器时，若路由器中有缓存的包，组播该包到NACK到达的接口链路，否则向上游转发NACK。

NACK抑制：主动路由器对每个丢失包维护一个NACK记录和修复记录，抑制重复的NACK。

###2.端到端拥赛控制

传统的端到端拥塞控制方法：

端节点检测拥塞，并在检测到拥塞后降低发送速率。发生拥塞的路由器从发生拥塞到接收到速率调整后的分组，一直处于拥塞状态。

主动节点参与的端到端拥塞控制：

- 路由器检测到拥塞后，立即要求其上游路由器设置过滤器，过滤从导致拥塞的端节点来的分组。
- 路由器将拥塞情况直接报告给端节点。
- 收到端节点的反应后，撤销过滤器。

###3.扩展的任意播

任意播（anycast）：发送方把分组发送给一组接收者中的任意一个。

组播：发送者把分组发送给一组接收者中的每一个。

任意播的推广：允许多于一个接收者收到分组。

PAMcast

###主动网络的问题

- 有特色的主动网络应用不多
- 未经过大规模实践的检验
- 互操作性难题（应用程序在多个操作系统上运行的兼容性问题）
- 尚缺乏完备的网络管理功能
- 网络安全如何保证（路由器具有执行程序的能力）

##OpenFlow和软件定义网络

网络创新对现实世界的影响力在下降：

- 现象：大部分的研究成果仅停留在实验室中，很少能够应用到实际的网络中。 
- 直接原因：目前没有切实可行的方法可以在足够真实的环境下对研究成果进行测试。
- 根源：网络基础设施已经僵化，新的功能很难加入到已有的网络中：
- 新的功能要求对因特网体系结构进行革命性改变（端到端原则不再适用）
- 网络设备全都是封闭系统（无法加载新的功能）

###可编程网络研究

GENI（Global Environment for Networking Innovation):

- 构建一个全国范围的实验性网络，用于研究新的网络体系结构和分布式系统；
- 用户可以申请全网范围内的一些资源构建起实验性网络；
- 优点：可编程网络降低了试验新技术的壁垒，提高了网络创新的速度；
- 缺点：费时、费力、费钱。

###OpenFlow

交换机/路由器的流表（flow table）

- 流表由很多个流表项组成，每个流表项就是一个转发规则；
- 数据包进入交换机后，通过查询流表获得转发的目的端口；
- 流表一般放在TCAM（三态内容可寻址存储器）中，以实现高速查找；
- 尽管不同设备厂商的流表不同，但有一些功能在许多交换机和路由器中都有。

###OpenFlow的解决思路

OpenFlow提供了一个编写交换机/路由器流表的开放协议：

- 允许管理员将网络流量划分成营运流和实验流，其中营运流仍然接受常规的处理。
- 研究者通过选择数据包要经过的路径及接受的处理来控制实验流，尝试新的处理技术。

###OpenFlow交换机

三部分组成：

- 一个流表：定义不同的流及各个流应如何处理
- 一个安全通道：用于交换机和远程控制器之间的安全通信
- OpenFlow协议：交换机与控制器通信的接口标准

运行机制：

新协议运行在一个控制器（如用户的PC机）上，通过OpenFlow接口在流表中添加或删除相关的表项，指导交换机/路由器进行相应处理（如转发到哪个端口、丢弃等），避免将新的协议加载到交换机上。

**OpenFlow方案的优点**

- 向研究者开放了因特网（可以修改流表）
- 满足设备制造商封闭平台的要求（不需要将新协议加载到交换机上）
- 具有商用设备的高性能和低价格的特点（本身就是商用设备）
- 能支持不同的研究范围
- 能隔绝实验流量和运行流量

####OpenFlow交换机分类

**Dedicated OpenFlow switch**

专门为支持OpenFlow而设计，不支持现有的商用交换机上的正常处理流程。

交换机不再具有控制逻辑（控制面），只是作为一个在端口间转发数据包的数据路径部件。

**OpenFlow-Enabled switch**

在商业交换机的基础上添加流表、安全通道和OpenFlow协议来获得OpenFlow特性。

既有商业交换机的转发模块，又有OpenFlow的转发逻辑，可以采用两种不同的方式处理接收到的数据包。

###流（flow）

RFC 3697定义流是从一个特定的源发送到一个特定的目的（单播地址、组播组、广播域）的一系列数据包。

OpenFlow中流的定义更宽泛些，指具有某种相同特征、需要进行相同处理的一系列数据包。比如：

- 一个TCP连接，来自特定MAC地址或IP地址的数据包，具有相同VLAN标签的数据包，来自同一个交换机端口的数据包等；
- 对于非IPv4数据包，可以是匹配某个特定报头的数据包。

###流表项

流表中的每个条目包含三个域：

- header：用于定义一个流
- Counters：流的统计信息（包数、字节数、最近一个数据包的到来时间）
- Action：处理数据包的动作

###流的处理动作

专用OpenFlow交换机定义的三个基本动作：

- 将数据包转发到一个或几个端口：通常要求线速转发。
- 封装并转发到控制器：将数据包封装后通过安全通道转发给控制器。（如流的第一个数据包）
- 丢弃数据包：通常用于安全目的，如丢弃洪泛攻击的包。

###支持OpenFlow的交换机

- 在商业交换机的基础上添加流表、安全通道和OpenFlow协议
- 流表一般会重用已有的硬件（如TCAM）
- 安全通道和OpenFlow协议要移植到交换机的操作系统上。 

###交换机类型

Type0交换机：只支持10元组header域和4种数据包处理动作的OpenFlow交换机，不能满足复杂实验的要求。

Type1交换机：支持更多的处理动作（如修改包头、将数据包映射到一个优先级），以及允许在header域中出现非IP头域等。

###控制器

控制器向流表中添加或删除流，其功能可简单、可复杂：

- 可以是运行在PC上的一个应用程序，在试验期间静态地建立流，将几个实验节点连接起来。（类似于VLAN）
- 可以在实验过程中动态地添加或删除流。 
- 可以支持多个研究者，允许他们在不同的流集合上运行各自的独立实验。  

###OpenFlow的使用例子

Amy想在网络中测试她设计的Amy-OSPF路由协议，并只对从她的PC机上发送出去的流使用Amy-OSPF。

- Amy-OSPF运行在一个控制器上。
- 在与她的PC机相连的OpenFlow交换机上定义一个流，凡是从其PC机进入该交换机的包都属于这个流，该流的处理动作为“封装并转发到控制器”。
- 当第一个分组从其PC机进入交换机时，分组被发送给控制器。
- 控制器使用Amy-OSPF为该流确定一条路径，并在该路径经过的每一个交换机上为该流添加一个表项。
- 后来的分组进入这些交换机时，按照流表的指示转发。 

###控制器的性能、可靠性和扩放性

集中式控制器的处理速度能跟上新流的到达速度吗？

- 用一台低端PC机实现的控制器，每秒可以处理一万个新流。 

可靠性和扩放性？ 

- 可以使用几个控制器和简单的负载均衡机制来构成一个分布式系统。

###OpenFlow的应用

- 校园网：提供测试新协议和新算法的平台。
- 广域网和移动网络：移动管理，电源管理。
- 数据中心：数据中心内部重路由网络流量（节能，路由失效恢复）
- 网络管理和安全控制：按照安全策略控制流的传输路径。
- 软件定义网络：在分离的控制面和数据面之间提供通信接口。

###OpenFlow的前景

- OpenFlow开辟了一个全新的研究领域，允许我们通过一种优雅而有效的方法将多年来的研究成果应用到实际网络中。
- 2008和2009连续两年获得SIGCOMM最佳演示奖。
- MIT Technology Review将其列为十大未来技术之一。
- 已在十多个科研机构中部署，并将在国家科研骨干网以及其它科研和生产中应用。
- 一些重要的设备厂商已经提供了支持OpenFlow的交换机。
- 二十几家公司组成了一个开放网络基金会（ONF），目标是让开放和可编程网络成为主流。

##软件定义网络（SDN）

Software Defined Networks

软件定义网络是指网络的控制面与物理拓扑分离的一种网络体系结构：

- 交换机只运行数据面，根据交换机内部的流表进行数据包转发；
- 控制面运行在单独的服务器上，为每个流建立转发路径，并下发到路径上的所有交换机中。

用户可以通过编写运行在控制器上的程序来控制自己的流（软件定义网络）。

###软件定义网络与OpenFlow

软件定义网络的组成：

- 控制器、交换机，控制器和交换机之间的通信协议。
- OpenFlow是目前已经提出的一种控制器和交换机之间的通信协议。

软件定义网络和OpenFlow：

- 软件定义网络是一种网络体系结构。
- OpenFlow是实现SDN的一种通信协议，SDN也可以不用OpenFlow作为通信协议。

###SDN控制器

控制器是SDN的控制中枢，负责维护整个网络的完整视图，为每一个流建立转发路径。

NOX是第一个SDN控制器原型，为用户提供统一的、集中式的编程接口，使得用户可以方便地编写程序来管理网络。

NOX实际上实现了一个网络操作系统。

**网络操作系统带来的好处**

网络操作系统提供集中式的编程模型，就好像整个网络是在一台计算机上，从而可以采用集中式算法而不是分布式算法。 

程序使用高级抽象（如用户和主机名）而不是低级配置参数（如IP和MAC地址）书写，从而管理指令可独立于网络拓扑，网络操作系统维护高层抽象和低级配置参数之间的绑定。

网络管理应用可以写成基于高级抽象的集中式程序，而不是基于低级配置参数的分布式算法。

###基于NOX的网络

一组OpenFlow交换机

一个（或几个）服务器，上面运行了：

- 控制器程序
- 网络视图（或拷贝）
- 管理应用

**观察与控制的粒度**

观察粒度：

- NOX的网络视图包括交换机一级的拓扑，用户、主机、中间系统及其它网元的位置，提供的服务（如 HTTP，NFS）。
- NOX的网络视图包括所有名字和地址之间的绑定（缓变状态），但不包括网络流量的当前状态（瞬变状态）。

控制粒度：NOX以流为单位进行控制。

**网络运行**

OpenFlow交换机用形如<header: counters, actions>的流表表示。

若输入分组匹配特定的header，计数器被更新，并且相应的动作被执行。

如果分组匹配多个表项，优先级最高的表项被选中。

如果输入分组不匹配任何一个表项（如一个流的第一个分组），分组被转发给控制器。

**扩放性分析**

NOX处理发生在三个时间尺度上：

- 数据包到达：对于10Gbps链路，包到达速率为Mpps量级。（由交换机处理）
- 新流启动：一般比包的到达速率低一到几个数量级。（由控制器实例处理）
- 网络视图发生变化：包含几千台主机的网络，网络视图发生变化的事件大约为每秒几十个。

网络视图是唯一需要保持一致性的全局状态。（缓变，可以集中维护）

据粗略估计，运行在一台普通PC机上的控制器程序每秒可以处理10万个新流。

**编程接口**

NOX运行在用户空间，提供事件驱动的编程接口，核心代码用C++写成。

管理应用可以用Python或C++编写，动态加载。

NOX的编程接口围绕事件、名字空间和网络视图：

- 事件可由OpenFlow消息直接产生，或由NOX应用程序在处理了低级事件或其它应用产生的事件之后产生，应用程序调用注册的处理程序来处理事件。
- NOX包含许多基础应用，用于构造网络视图和维护高层名字空间，供管理应用使用。

程序员以拓扑无关的方式编写应用程序，NOX负责在高层名字和低级地址之间进行映射。

**网络控制**

管理应用通过OpenFlow执行网络控制：

- 应用可向流表中插入、删除表项，或从表项中读取计数器值；
- 通过修改流表表项，管理应用可有完全的二层路由，修改包头和访问控制的能力。

NOX应用可以将数据包定向到专门的中间系统，以实现对数据包的定制处理。

## Clean Slate Design for the Internet

**Clean Slate计划：**如果我们以20-30年的后见之明重新设计一个因特网，我们会设计出什么样的因特网？

四大项目：

- 因特网架构：OpenFlow and Software Defined Networking
- 移动因特网：POMI 2020
- 移动社交网络：MobiSocial
- 数据中心：Stanford Experimental Data Center Lab

架构刚性指缺乏通过可增量部署解决问题的能力。

不是要设计出一套能满足一系列特性（如安全性、可靠性、可扩放性）的完整的网络组件集合（如特定的路由方法、寻址方法、命名方法），而是要提出一个框架，在该框架下完整的网络组件集合：

- 能够作为全功能架构运行，满足各种需要的特性；
- 不需要静态和一致地部署，而是可以共存、通信和随时间演化。

三个核心接口是需要固定的：

- 域间通信接口（即域间路由）
- 应用和网络的接口（即网络API）
- 主机用于抵御DoS攻击的接口

由这三个核心接口构成的框架成为FII（Framework for Internet Innovation）
