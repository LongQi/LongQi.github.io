---
layout: post
---
#多处理机系统

三种类型：

- 共享存储器多处理机
- 消息传递多计算机：许多CPU-存储器通过某种高速互联装置连接在一起，每个存储器局部对应一个CPU，且只能被该CPU访问。
- 广域分布式系统：所有的计算机系统通过一个广域网连接起来，构成一个分布式系统。

##多处理机

共享存储器多处理机，其两个或更多的CPU全部共享访问一个公用的RAM。运行在任何一个CPU上的程序都看到一个普通（通常是分页）的虚拟地址空间。

###多处理机硬件

- UMA基于总线的SMP体系结构
- 使用交叉开关的UMA多处理机
- 使用多级交换网络的UMA多处理机
- NUMA多处理机

###多处理机操作系统类型

- 每个CPU有自己的操作系统
- 主从多处理机
- 对称多处理机

###多处理机同步

在多处理机中CPU经常需要同步，内核临界区、表等。

TSL（Test and Set Lock）

轮转与切换，如果在一个CPU中的某些线程需要访问文件系统缓冲区高速缓存，而该文件系统缓冲区高速缓存正好锁住了，那么CPU可以决定切换至另外一个线程而不是等待。

###多处理机调度

在多处理机中，调度是二维的，调度程序必须决定哪一个进程运行以及在哪一个CPU上运行。

**分时系统**

这是调度独立进程的情况，处理独立进程的最简单算法是，为就绪进程准备一个系统及的大数据结构，这可能只是一个列表，但更多的情况下可能是在不同优先级下的一个列表集合。

两级调度算法（two-level scheduling algorithm）的优点：

- 它把负载大致平均分配在可用的CPU上；
- 它尽可能发挥了高速缓存亲和力的优势；
- 通过为每个CPU提供自用的一份就绪列表，使就绪列表的竞争减到了最小，因为试图使用另一个CPU的就绪列表的机会相对较小。

**空间共享**

一个含有多个相关进程的作业或者一个包含多个内核线程的进程，基本上是一回事。在多个CPU上同时调度多个线程称为空间共享。

最简单的空间共享算法是这样的，假设一次创建了一组相关的线程。在其创建的时刻，调度程序检查是否有同线程数量一样多的空闲CPU存在。如果有，每个线程获得各自指定的CPU并且都开始运行。如果没有足够的CPU，就没有线程开始运行，直到有足够的CPU时为止。

**群调度**

空间共享的明显优点是消除了多道程序设计，这样消除了上下文切换的负担。但是，一个同样明显的缺点是时间的浪费。

群调度（gang scheduling）的三个部分：

- 把一组相关进程作为一个单位，即一个群，一起调度；
- 一个群中的所有成员在不同分时处理的CPU上同时运行；
- 群中的所有成员一起开始和结束其时间片。

使群调度正确工作的关键是，同步调度所有的CPU，这意味着把时间划分为离散的时间片，在每个新的时间片开始时，所有的CPU都重新调度，在每个CPU上都开始一个新的线程。在后续的时间片开始时，另一个调度事件发生。在这之间，没有调度行为。

群调度的思想是，让一个进程的所有线程一起运行，这样，如果其中一个线程向另一个线程发送请求，接受方几乎会立即得到这个消息，并且几乎能够立即应答。

##多计算机

机群计算机（cluster computer），工作站机群（clusters of workstations）

###多计算机硬件

一台计算机的基本节点包括一个CPU，存储器，一个网络接口，有时还有一个硬盘。

**互连技术**

- 单交换机
- 环
- 网格，直径：任意两个节点之间的最长路径，其随着节点数目的平方根增加
- 双凸面
- 立方体
- 超立方体：其直径随着维数的增加线性增长

两种交换机制：

- 存储转发包交换（store-and-forward packet switching）
- 电路交换

**网络接口**

- 接口板上都有一些用来存储进出包的RAM；
- 接口板上可以有一个或多个DMA通道，甚至在板上有一片完整的CPU；
- 有些接口板上有完整的CPU，可能另外还有一个或多个DMA通道。

###低层通信软件

###用户层通信软件

**发送和接收**

send(dest, &mptr);

receive(addr, &mptr);

**阻塞调用和非阻塞调用**

非阻塞调用，如果send是非阻塞的，在消息发出之前，它立即将控制返回给调用者。这种机制的优点是发送进程可以继续运算，与消息传送并行，而不是让CPU空闲。

###远程过程调用

允许程序调用定位在其他CPU中的过程，当机器1的进程调用机器2的过程时，在机器1中的调用进程被挂起，在机器2中被调用的过程执行。可以在参数中传递从调用者到被调用者的信息，并且可在过程的处理结果中返回信息。

远程过程调用（Remote Procedure Call, RPC）,要调用一个远程过程，客户程序必须被绑定在一个称为客户机存根的小型库过程上，它在客户机的地址空间中代表服务器过程。类似地，服务器程序也绑定在一个称为服务器存根的过程上。这些过程隐藏了这样一个事实，即从客户机到服务器的过程调用并不是本地调用。

**实现问题**

- 指针参数的使用
- 使用全局变量

###分布式共享存储器

分布式共享存储器（Distributed Shared Memory, DSM）

在DSM系统中，地址空间被划分为页面，这些页面分布在系统中的所有节点上。当一个CPU引用一个非本地的地址时，就产生一个陷阱，DSM软件调取包含该地址的页面并重新开始出错指令，该指令现在可以完整地执行了。

**复制**

一项对基本系统的改进是复制那些只读页面，如程序正文、只读常数或其他只读数据结构，从而可以较好地提高性能。

另一种，不仅复制只读页面，而且复制所有的页面。

**伪共享**

尽管多个变量是无关的，但它们碰巧正好在同一个页面内，所以当某个进程使用其中一个变量时，它也得到另一个。有效页面越大，发生伪共享的可能性也越高。

**实现顺序一致性**

如果有一个进程试图在一个被复制的页面上写入，潜在的一致性问题就会出现，因为只修改一个副本却不管其他副本的做法是不能接受的。

在对一个共享页面进行写入之前，先向所有持有该页面副本的CPU发出一条消息，通知它们撤销映像并丢弃该页面。在其所有撤销映像等工作完成之后，该CPU便可以进行写操作了。

###多计算机调度

一旦确定了每个节点自己的进程，就可以应用任何本地调度算法。

###负载平衡

**图论确定算法**

用一个带权图来表征，每个顶点是一个进程，而每个弧代表两个进程之间的消息流，该问题就简化为在特定的限制条件下，寻找一个将图划分为若干个互不连接的子图的方法。

最小割问题。

**发送者发起分布式启发算法**

当进程被创建时，它就运行在创建它的节点上，除非该节点过载了。如果过载了，该节点任意选择另一个节点并询问它的负载情况。如果被探查的节点负载低于某些阈值，就将新的进程发送到该节点上。如果不是，则选择另一个机器探查。

算法思想：负载较重的节点试图甩掉超额的工作。

**接收者发起分布式启发算法**

在这个算法中，只要有一个进程结束，系统就检查是否有足够的工作可做。如果不是，它随机选择某台机器并要求为它工作。如果该台机器没有可提供的工作，会接着询问第二台，然后第三台... ...

这个算法的优点是，在关键时刻它不会在系统上增加额外的负担。

**竞标算法**

拍卖系统：参与者是进程和节点，进程必须购买CPU时间以完成他们的工作，而节点则将其CPU周期拍卖给出价最高的竞买者。

##分布式系统

每个节点都有自己的私有存储器，整个系统中没有共享的物理存储器。

分布式系统面对不同硬件和操作系统实现某种统一测度的途径是，在操作系统的顶部添加一个软件层。这层称为中间件（middleware），这层提供了一些特定的数据结构和操作，从而可以允许进程和用户在远端的机器上用一致的方式互操作。

- 基于文档的中间件
- 基于文件系统的中间件
- 基于共享对象的中间件
- 基于协作的中间件